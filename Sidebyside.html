<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>左鄰有「你」- 心之迷途</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        body {
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.6;
            overflow-x: hidden;
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #121212 70%);
        }

        .game-container {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .game-title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #4a148c, 0 0 20px #4a148c; }
            to { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #4a148c, 0 0 40px #4a148c; }
        }

        .game-subtitle {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.8;
        }

        .stage, .game-section {
            display: none;
            animation: fadeIn 1s ease;
        }

        .stage.active, .game-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stage-title, .game-title h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #9c27b0;
            border-bottom: 1px solid rgba(156, 39, 176, 0.3);
            padding-bottom: 10px;
        }

        .stage-description, .game-description {
            margin-bottom: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .story-section {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .story-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(74, 20, 140, 0.1) 0%, rgba(0, 0, 0, 0) 100%);
            pointer-events: none;
        }

        .story-section.objective {
            background-color: rgba(33, 150, 243, 0.1);
            border-left: 3px solid #2196F3;
        }

        .story-section.note {
            background-color: rgba(255, 152, 0, 0.1);
            border-left: 3px solid #FF9800;
            font-style: italic;
        }

        .input-section {
            margin: 20px 0;
            text-align: center;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        input[type="text"]::placeholder, input[type="password"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        button {
            padding: 10px 20px;
            background-color: #4a148c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #6a1b9a;
            transform: translateY(-2px);
        }

        .error-message {
            color: #f44336;
            font-size: 0.9rem;
            margin-top: 5px;
            min-height: 1.5em;
        }

        .hint {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
            font-style: italic;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4a148c 0%, #9c27b0 100%);
            width: 0%;
            transition: width 1s ease;
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.7);
        }

        .location-guide {
            background-color: rgba(33, 150, 243, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            position: relative;
        }

        .location-title {
            color: #2196F3;
            font-size: 1.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .location-icon {
            margin-right: 10px;
            font-size: 1.4rem;
        }

        .location-path {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .location-step {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-step:hover {
            background-color: rgba(33, 150, 243, 0.2);
        }

        .location-step.active {
            background-color: rgba(33, 150, 243, 0.3);
            font-weight: bold;
        }

        .location-arrow {
            color: #aaa;
            font-size: 0.8rem;
        }

        .location-clue {
            margin-top: 10px;
            font-style: italic;
            color: #bbb;
            font-size: 0.9rem;
        }

        .notebook {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            margin: 30px auto;
            position: relative;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            height: 250px;
            cursor: pointer;
            perspective: 1000px;
            transition: all 0.5s ease;
            z-index: 10;
        }

        .notebook-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .notebook.flipped .notebook-inner {
            transform: rotateY(180deg);
        }

        .notebook-front, .notebook-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .notebook-front {
            background-color: #4a148c;
            align-items: center;
            padding: 20px;
        }

        .notebook-back {
            background-color: rgba(255, 255, 255, 0.05);
            transform: rotateY(180deg);
            padding: 15px;
            overflow-y: auto;
        }

        .notebook-title {
            color: #aaa;
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: normal;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .notebook-entry {
            margin-bottom: 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #ddd;
        }

        .notebook-highlight {
            color: #ce93d8;
            font-weight: bold;
        }

        .envelope-icon {
            font-size: 3rem;
            color: #fff;
        }

        .progress-map-container {
            position: relative;
            width: 100%;
            height: 150px;
            margin: 30px 0;
            overflow: hidden;
        }

        .progress-map {
            width: 100%;
            height: 100%;
        }

        .progress-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawPath 2s forwards ease-out;
        }

        @keyframes drawPath {
            to { stroke-dashoffset: 0; }
        }

        .progress-node {
            fill: #444;
            transition: all 0.5s ease;
            cursor: pointer;
        }

        .progress-node.current {
            fill: #9c27b0;
            filter: drop-shadow(0 0 5px rgba(156, 39, 176, 0.7));
        }

        .progress-node.completed {
            fill: #4caf50;
        }

        .progress-node.locked {
            fill: #444;
        }

        .progress-label {
            fill: #aaa;
            font-size: 0.7rem;
            text-anchor: middle;
            pointer-events: none;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 200px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
        }

        .location {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .location::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1);
            z-index: -1;
        }

        .location:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .location-label {
            position: absolute;
            bottom: -20px;
            white-space: nowrap;
            font-size: 0.8rem;
            color: #aaa;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .location.pulse::after {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(2); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }

        .hidden-clue {
            position: absolute;
            visibility: hidden;
            opacity: 0;
        }

        .community-map {
            width: 100%;
            height: 250px;
            background-color: #1a1a2e;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .community-building {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .community-building:hover {
            filter: brightness(1.3);
        }

        .community-label {
            fill: white;
            font-size: 0.8rem;
            text-anchor: middle;
            pointer-events: none;
        }

        .treasure-box {
            width: 200px;
            height: 150px;
            background-color: #3e2723;
            border-radius: 10px;
            margin: 20px auto;
            position: relative;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .treasure-box::before {
            content: '';
            position: absolute;
            width: 80%;
            height: 10px;
            background-color: #5d4037;
            top: 40px;
            left: 10%;
            border-radius: 5px;
        }

        .treasure-box::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 20px;
            background-color: #fbdc05;
            top: 60px;
            left: calc(50% - 20px);
            border-radius: 5px;
            box-shadow: 0 0 10px #fbdc05;
            transition: all 0.3s ease;
        }

        .treasure-box:hover {
            transform: scale(1.05);
        }

        .treasure-box.open {
            background-color: #4e342e;
        }

        .treasure-box.open::before {
            animation: openLid 1s forwards;
        }

        @keyframes openLid {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(-90deg); opacity: 0; }
        }

        .treasure-box.open::after {
            animation: glowKey 1s infinite alternate;
        }

        @keyframes glowKey {
            from { box-shadow: 0 0 10px #fbdc05; }
            to { box-shadow: 0 0 20px #fbdc05, 0 0 40px #fbdc05; }
        }

        .treasure-box.shake {
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        .phone {
            width: 180px;
            height: 300px;
            background-color: #000;
            border-radius: 20px;
            margin: 20px auto;
            position: relative;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .phone-screen {
            width: 100%;
            height: 85%;
            background-color: #121212;
            border-radius: 10px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .phone-button {
            width: 40px;
            height: 40px;
            background-color: #333;
            border-radius: 50%;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .phone-button:hover {
            background-color: #444;
        }

        .message {
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-break: break-word;
            font-size: 0.9rem;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message.incoming {
            background-color: #263238;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.outgoing {
            background-color: #4a148c;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .food-item {
            width: 80px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .food-item:hover {
            transform: translateY(-5px);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .food-img {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .effect-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }

        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #fff;
            animation: fadeOut 1s forwards;
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0); }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 1;
            animation: fall 3s forwards linear;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .achievements {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .achievement {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            font-size: 2rem;
            opacity: 0.3;
        }

        .achievement.unlocked {
            background-color: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 15px gold;
            opacity: 1;
        }

        .achievement-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.8rem;
            color: #aaa;
        }

        .achievement.unlocked .achievement-label {
            color: gold;
        }

        .money-collection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .money-item {
            width: 80px;
            height: 80px;
            background-color: #fbdc05;
            border-radius: 50%;
            color: #000;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(251, 220, 5, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .money-item:hover {
            transform: translateY(-5px) rotate(10deg);
            box-shadow: 0 0 15px rgba(251, 220, 5, 0.7);
        }

        .money-value {
            font-size: 1.5rem;
        }

        .eerie-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.5) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .void-circle {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.2);
            transform: translate(-50%, -50%);
            animation: pulse-void 4s infinite alternate;
        }

        @keyframes pulse-void {
            0% { box-shadow: 0 0 10px rgba(74, 20, 140, 0.3); }
            100% { box-shadow: 0 0 30px rgba(74, 20, 140, 0.7); }
        }

        .void-heart {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 20px auto;
        }

        .void-heart::before, .void-heart::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 80px;
            border: 2px solid #4a148c;
            border-radius: 50px 50px 0 0;
            background-color: transparent;
        }

        .void-heart::before {
            transform: rotate(-45deg);
            left: 20px;
        }

        .void-heart::after {
            transform: rotate(45deg);
            right: 20px;
        }

        .void-heart.filling::before, .void-heart.filling::after {
            background-color: rgba(74, 20, 140, 0.3);
            animation: fill-heart 2s forwards;
        }

        @keyframes fill-heart {
            0% { background-color: rgba(74, 20, 140, 0); }
            100% { background-color: rgba(74, 20, 140, 0.7); }
        }

        .fog {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxmaWx0ZXIgaWQ9ImZvZyI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuMDEiIG51bU9jdGF2ZXM9IjUiIHN0aXRjaFRpbGVzPSJzdGl0Y2giIHJlc3VsdD0ibm9pc2UiIC8+PGZlQ29sb3JNYXRyaXggaW49Im5vaXNlIiB0eXBlPSJtYXRyaXgiIHZhbHVlcz0iMSAwIDAgMCAwIDAgMSAwIDAgMCAwIDAgMSAwIDAgMCAwIDAgMC4xIDAiIHJlc3VsdD0iZm9nIiAvPjwvZmlsdGVyPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ0cmFuc3BhcmVudCIgZmlsdGVyPSJ1cmwoI2ZvZykiIC8+PC9zdmc+');
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }

        .dialogue-container {
            position: relative;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            font-size: 1rem;
            margin: 15px 0;
            text-align: left;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.5s ease;
        }

        .dialogue-container.show {
            max-height: 300px;
            opacity: 1;
            margin: 15px 0;
        }

        .dialogue-text {
            margin: 5px 0;
            color: #fff;
        }

        .dialogue-name {
            color: #9c27b0;
            font-weight: bold;
            margin-right: 10px;
        }

        .typing-effect {
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid #fff;
            animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #fff }
        }

        .cutscene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .cutscene.active {
            opacity: 1;
            visibility: visible;
        }

        .cutscene-content {
            max-width: 800px;
            text-align: center;
        }

        .cutscene-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 0 10px rgba(156, 39, 176, 0.7);
        }

        .cutscene-text {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
            color: #eee;
        }

        .cutscene-continue {
            font-size: 1rem;
            color: #aaa;
            margin-top: 30px;
            animation: pulse 1s infinite alternate;
        }

        .envelope-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1500;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
        }

        .envelope-container.active {
            opacity: 1;
            visibility: visible;
        }

        .envelope-svg {
            width: 300px;
            height: 200px;
            position: relative;
            perspective: 1000px;
        }

        .envelope-body {
            fill: #4a148c;
            stroke: #6a1b9a;
            stroke-width: 2;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
        }

        .envelope-flap {
            fill: #6a1b9a;
            transform-origin: center top;
            transition: transform 2s ease;
        }

        .envelope-container.opening .envelope-flap {
            transform: rotateX(180deg);
        }

        .envelope-letter {
            position: absolute;
            width: 260px;
            height: 160px;
            background: white;
            border-radius: 5px;
            top: 20px;
            left: 20px;
            padding: 15px;
            transform: translateY(0);
            transition: transform 1s ease;
            z-index: -1;
            color: #333;
            font-size: 0.9rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .envelope-container.opening .envelope-letter {
            transform: translateY(-100px);
            z-index: 1;
        }

        .letter-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #4a148c;
            font-weight: bold;
        }

        .letter-content {
            text-align: center;
            line-height: 1.4;
        }

        .envelope-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle at center, rgba(156, 39, 176, 0.3) 0%, transparent 70%);
            filter: blur(10px);
            animation: envelope-pulse 2s infinite alternate;
        }

        @keyframes envelope-pulse {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }

        .key-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.5s ease, transform 1s ease;
        }

        .key-effect.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.5);
        }

        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #121212;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #121212 70%);
        }

        .start-screen .game-title {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .start-screen .game-subtitle {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }

        .start-screen button {
            padding: 15px 30px;
            font-size: 1.2rem;
            background-color: #4a148c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-screen button:hover {
            background-color: #6a1b9a;
            transform: scale(1.1);
        }

        .hint-card {
            position: relative;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.5s ease;
        }

        .hint-card.show {
            max-height: 300px;
            opacity: 1;
            margin: 15px 0;
        }

        .hint-btn {
            background-color: rgba(33, 150, 243, 0.2);
            color: #2196F3;
            border: 1px solid #2196F3;
            margin-top: 5px;
        }

        .hint-btn:hover {
            background-color: rgba(33, 150, 243, 0.3);
        }

        /* Code2 樣式整合 */
        :root {
            --main-bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --accent-color: #ff3030;
            --secondary-color: #303030;
            --success-color: #30b030;
            --highlight-color: #ff9900;
        }

        .game-section {
            background-color: rgba(20, 20, 20, 0.8);
            border: 1px solid var(--accent-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(255, 48, 48, 0.2);
            position: relative;
            overflow: hidden;
        }

        .location-tag {
            background-color: var(--accent-color);
            color: var(--main-bg-color);
            padding: 5px 10px;
            border-radius: 5px;
            margin-right: 10px;
            font-weight: bold;
        }

        .game-content {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .control-panel {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--secondary-color);
        }

        .control-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px;
        }

        .control-button:hover {
            background-color: var(--highlight-color);
        }

        .success-message {
            color: var(--success-color);
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border: 1px solid var(--success-color);
            border-radius: 5px;
            display: none;
        }

        /* 心連心傳密碼 */
        .circle-game {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .circle-animation {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 20px 0;
        }

        .player {
            width: 40px;
            height: 40px;
            background-color: var(--secondary-color);
            border: 2px solid var(--text-color);
            border-radius: 50%;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .player.active {
            background-color: var(--highlight-color);
            box-shadow: 0 0 15px var(--highlight-color);
        }

        .circle-line {
            position: absolute;
            height: 2px;
            background-color: var(--text-color);
            transform-origin: left center;
        }

        .password-display {
            font-size: 1.5em;
            margin: 20px 0;
            letter-spacing: 10px;
        }

        .attempts-counter {
            font-size: 1.2em;
            margin: 10px 0;
        }

        /* 巴士線配對 */
        .bus-matching {
            display: flex;
            flex-direction: column;
        }

        .bus-question {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(50, 50, 50, 0.5);
            border-radius: 5px;
        }

        .bus-question input {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--text-color);
            padding: 8px;
            margin: 0 10px;
            width: 100px;
            border-radius: 3px;
        }

        .check-result {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .check-icon {
            color: var(--success-color);
            font-size: 1.5em;
            display: none;
        }

        /* 默契大考驗 */
        .action-challenge {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .action-display {
            font-size: 2em;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            padding: 20px;
            width: 100%;
            background-color: rgba(50, 50, 50, 0.5);
            border-radius: 10px;
            text-align: center;
        }

        .countdown {
            font-size: 4em;
            margin: 20px 0;
            color: var(--highlight-color);
        }

        .success-counter {
            font-size: 1.2em;
            margin-top: 20px;
        }

        /* 開口中 */
        .number-guessing {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .number-range {
            font-size: 1.5em;
            margin: 20px 0;
        }

        .guess-input {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .guess-input input {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--text-color);
            padding: 10px;
            width: 100px;
            font-size: 1.2em;
            border-radius: 5px;
            margin-right: 10px;
            text-align: center;
        }

        .guess-button {
            background-color: var(--highlight-color);
            color: var(--main-bg-color);
            border: none;
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 5px;
        }

        .clues-container {
            margin-top: 30px;
            width: 100%;
        }

        .clue {
            padding: 15px;
            margin: 10px 0;
            background-color: rgba(50, 50, 50, 0.5);
            border-radius: 5px;
            opacity: 0.3;
        }

        .clue.revealed {
            opacity: 1;
            border-left: 5px solid var(--success-color);
        }

        /* 字母拼字挑戰 */
        .letter-challenge {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .people-counter {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .counter-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 5px;
        }

        .people-count {
            font-size: 1.5em;
            margin: 0 20px;
            width: 40px;
            text-align: center;
        }

        .word-display {
            font-size: 4em;
            letter-spacing: 15px;
            margin: 30px 0;
            color: var(--highlight-color);
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
        }

        /* 大電視解謎 */
        .tv-game {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tv-screen {
            width: 80%;
            height: 200px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 3px solid var(--secondary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            font-size: 2.5em;
            padding: 20px;
            text-align: center;
        }

        .tv-controls {
            display: flex;
            gap: 10px;
        }

        .progress-display {
            margin-top: 20px;
            font-size: 1.2em;
        }

        /* 特效 */
        .glitch {
            position: relative;
        }

        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 red;
            clip: rect(0, 900px, 0, 0);
            animation: glitch-anim-1 2s infinite linear alternate-reverse;
        }

        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 blue;
            clip: rect(0, 900px, 0, 0);
            animation: glitch-anim-2 2s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim-1 {
            0% { clip: rect(20px, 9999px, 21px, 0); }
            25% { clip: rect(12px, 9999px, 59px, 0); }
            50% { clip: rect(62px, 9999px, 78px, 0); }
            75% { clip: rect(34px, 9999px, 94px, 0); }
            100% { clip: rect(53px, 9999px, 40px, 0); }
        }

        @keyframes glitch-anim-2 {
            0% { clip: rect(65px, 9999px, 119px, 0); }
            25% { clip: rect(31px, 9999px, 65px, 0); }
            50% { clip: rect(9px, 9999px, 85px, 0); }
            75% { clip: rect(25px, 9999px, 68px, 0); }
            100% { clip: rect(20px, 9999px, 30px, 0); }
        }

        .flicker {
            animation: flicker 2s infinite alternate;
        }

        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% { opacity: 1; }
            20%, 24%, 55% { opacity: 0.5; }
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.03) 50%, transparent);
            animation: scan 8s linear infinite;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes scan {
            from { transform: translateY(-100%); }
            to { transform: translateY(100%); }
        }

        /* 挑戰按鈕 */
        .challenge-btn {
            background-color: #ff3030;
            color: white;
            padding: 12px 24px;
            font-size: 1.1rem;
        }

        .challenge-btn:hover {
            background-color: #ff5050;
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    <div class="eerie-effect"></div>
    <div class="fog"></div>
    <div class="scan-line"></div>

    <div class="start-screen">
        <h1 class="game-title glow">左鄰有「你」</h1>
        <p class="game-subtitle">尋找心之鎖匙</p>
        <button id="gameStartBtn">Game Start</button>
    </div>

    <div class="game-container">
        <h1 class="game-title glow">左鄰有「你」</h1>
        <p class="game-subtitle">尋找心之鎖匙</p>

        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>

        <!-- 信封動畫容器 -->
        <div class="envelope-container" id="envelope-container">
            <div class="envelope-glow"></div>
            <svg class="envelope-svg" viewBox="0 0 300 200">
                <rect class="envelope-body" x="20" y="50" width="260" height="150" rx="5"/>
                <path class="envelope-flap" d="M20,50 L150,120 L280,50 L280,50 L150,20 L20,50 Z"/>
                <path class="envelope-fold" d="M20,50 L150,120 L20,200" fill="none" stroke="#6a1b9a" stroke-width="1" opacity="0.5"/>
                <path class="envelope-fold" d="M280,50 L150,120 L280,200" fill="none" stroke="#6a1b9a" stroke-width="1" opacity="0.5"/>
            </svg>
            <div class="envelope-letter" id="envelope-letter">
                <h3 class="letter-title" id="letter-title">心之迷途</h3>
                <p class="letter-content" id="letter-content">你醒來於一個熟悉又陌生的空間，這裡像是社區的倒影，卻籠罩著詭異的氛圍。更奇怪的是，你感覺不到任何情感，如同心是空洞的。</p>
            </div>
        </div>

        <!-- 過場動畫容器 -->
        <div class="cutscene" id="cutscene">
            <div class="cutscene-content">
                <h2 class="cutscene-title" id="cutscene-title"></h2>
                <p class="cutscene-text" id="cutscene-text"></p>
                <p class="cutscene-continue">點擊任意處繼續...</p>
            </div>
        </div>

        <!-- 進程地圖 -->
        <div class="progress-map-container">
            <svg class="progress-map" viewBox="0 0 800 100" preserveAspectRatio="xMidYMid meet">
                <path class="progress-path" d="M50,50 C150,20 250,80 350,50 C450,20 550,80 650,50 S750,20 750,50" 
                    stroke="#444" stroke-width="10" fill="none" stroke-linecap="round"/>
                <circle class="progress-node current" id="node0" cx="50" cy="50" r="10"/>
                <text class="progress-label" x="50" y="75">1. 善匯(起點)</text>
                <circle class="progress-node locked" id="node1" cx="190" cy="30" r="10"/>
                <text class="progress-label" x="190" y="15">2. 熟悉的巴士線</text>
                <circle class="progress-node locked" id="node2" cx="350" cy="50" r="10"/>
                <text class="progress-label" x="350" y="75">3. 速食點</text>
                <circle class="progress-node locked" id="node3" cx="480" cy="30" r="10"/>
                <text class="progress-label" x="480" y="15">4. 紅菱道之地</text>
                <circle class="progress-node locked" id="node4" cx="580" cy="70" r="10"/>
                <text class="progress-label" x="580" y="95">5. 食得是福</text>
                <circle class="progress-node locked" id="node5" cx="680" cy="40" r="10"/>
                <text class="progress-label" x="680" y="25">6. 生活救星</text>
                <circle class="progress-node locked" id="node6" cx="750" cy="50" r="10"/>
                <text class="progress-label" x="750" y="75">7. 生與熟之地</text>
            </svg>
        </div>

        <!-- 遊戲介紹 -->
        <div class="stage active" id="intro">
            <h2 class="stage-title">異空間----熟悉的陌生地(起點)</h2>
            <div class="notebook" id="notebook-intro">
                <div class="notebook-inner">
                    <div class="notebook-front">
                        <div class="envelope-icon">✉️</div>
                    </div>
                    <div class="notebook-back">
                        <h3 class="notebook-title">迷途筆記</h3>
                        <p class="notebook-entry">我似乎被困在一個熟悉又陌生的空間，社區的輪廓依稀可見，但一切都籠罩著詭異的氛圍。最奇怪的是，我感覺不到任何情感，如同心是空洞的。</p>
                        <p class="notebook-entry">神秘聲音提到了<span class="notebook-highlight">心之鎖匙</span>，似乎只有找到它，我和其他居民才能恢復。我需要跟隨<span class="notebook-highlight">記憶碎片</span>開始這段奇異的旅程。</p>
                    </div>
                </div>
            </div>
            <div class="dialogue-container show" id="intro-dialogue">
                <p class="dialogue-text typing-effect"><span class="dialogue-name">神秘聲音:</span>歡迎來到『心之迷途』，不同的任務等著你們...。</p>
            </div>
            <div class="story-section">

                <p>＊故事劇情＊</p>
                <p>你醒來發現自己身處一個熟悉又陌生的空間，彷彿是你曾經生活的社區，卻又微妙地不同。周圍的一切都籠罩著一層詭異的氛圍，而更奇怪的是，你感覺自己的心是空洞的。</p>
            </div>
            <div class="void-heart" id="introHeart"></div>
            <div class="story-section objective">
                <p><strong>謎之聲音：</strong>帶齊行李，馬上出發尋找「心之鎖匙」。</p>
            </div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">📍</span>當前位置</h3>
                <div class="location-path">
                    <div class="location-step active">善匯</div>
                </div>
                <p class="location-clue">密碼需要透過完成任務後獲得。</p>
            </div>
            <div class="map-container">
                <div class="location" style="top: 30%; left: 25%">
                    <span class="location-label">巴士站</span>
                </div>
                <div class="location" style="top: 50%; left: 60%">
                    <span class="location-label">地鐵站</span>
                </div>
                <div class="location" style="top: 70%; left: 40%">
                    <span class="location-label">小巴站</span>
                </div>
                <div class="void-circle" style="top: 30%; left: 25%; width: 40px; height: 40px;"></div>
                <div class="hidden-clue">電話密碼藏在數字：999</div>
            </div>
            <div class="input-section">
                <button id="startBtn">前往熟悉的巴士線</button>
            </div>
        </div>

        <!-- 第一關：熟悉的巴士線 -->
        <div class="stage" id="stage1">
            <h2 class="stage-title">第一關：出行易 (巴士線配對)</h2>
            <div class="story-section">
                <p>＊故事劇情＊</p>
                <p>你來到社區的熟悉的巴士線，周圍飄散著模糊的數字碎片。這些碎片似乎組成了某個特殊的密碼。</p>
                <p>「呢組密碼係咩?」你自言自語地思考著。</p>
                <p>「這些數字似乎在巴士站有關，需要完成任務找到密碼？」</p>
            </div>
            <div class="dialogue-container show" id="stage1-dialogue">
                <p class="dialogue-text"><span class="dialogue-name">突破方法:</span>參考關卡遊戲卡片</p>
            </div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">📍</span>當前位置</h3>
                <div class="location-path">
                    <div class="location-step">善匯</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step active">熟悉的巴士線</div>
                </div>
                <p class="location-clue">密碼需要透過完成任務後獲得。</p>
            </div>
            <div class="story-section objective">
                <p><strong>目標：</strong>使用記憶與科技幫助你尋找。</p>
            </div>
            <div class="map-container">
                <div class="location" style="top: 30%; left: 25%">
                    <span class="location-label">巴士站</span>
                </div>
                <div class="location" style="top: 50%; left: 60%">
                    <span class="location-label">地鐵站</span>
                </div>
                <div class="location" style="top: 70%; left: 40%">
                    <span class="location-label">小巴站</span>
                </div>
                <div class="void-circle" style="top: 30%; left: 25%; width: 40px; height: 40px;"></div>
                <div class="hidden-clue">電話密碼藏在數字：999</div>
            </div>
            <div class="input-section">
                <p class="hint">提示：可以使用電話</p>
                <input type="text" id="stage1Input" placeholder="輸入密碼...">
                <button id="stage1Btn">確認</button>
                <p class="error-message" id="stage1Error"></p>
                <button class="challenge-btn" id="challenge1Btn" style="display: none;">進入挑戰：巴士線配對</button>
            </div>
            <div class="key-effect" style="display: none;">
                <svg width="50" height="50" viewBox="0 0 50 50">
                    <path d="M10 10 L20 20 M20 10 L10 20" stroke="#fbdc05" stroke-width="2"/>
                </svg>
            </div>
            <div class="hint-card" id="hint1">
                <p>你獲得【手機通訊】功能，並請前往下一個目的地：餐廳!!</p>
            </div>
            <button class="hint-btn" id="showHint1">下一站地點</button>
        </div>

        <!-- 第二關：餐廳 -->
        <div class="stage" id="stage2">
            <h2 class="stage-title">第二關：熟悉的人 (字母拼字挑戰)</h2>
            <div class="story-section">
                <p>＊故事劇情＊</p>
                <p>當你來到一家餐廳，請即刻完成任務。</p>
                <p>「唔通要打比電話中既人問佢係邊個?」你心想，這似乎是唯一的辦法了。</p>
            </div>
            <div class="dialogue-container show" id="stage2-dialogue">
                <p class="dialogue-text"><span class="dialogue-name">突破方法:</span>參考關卡遊戲卡片</p>
            </div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">📍</span>當前位置</h3>
                <div class="location-path">
                    <div class="location-step">善匯</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">熟悉的巴士線</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step active">餐廳</div>
                </div>
                <p class="location-clue">密碼需要透過完成任務後獲得。</p>
            </div>
            <div class="story-section objective">
                <p><strong>目標：</strong>利用身體帶出訊息。</p>
            </div>
            <div class="phone">
                <div class="phone-screen" id="phoneScreen"></div>
                <div class="phone-button" id="phoneButton"></div>
            </div>
            <div class="story-section note">
                <p>號碼已經輸入在撥號介面上。現在你需要詢問接電話的人是誰，直接輸入答案。</p>
            </div>
            <div class="input-section">
                <p class="hint">提示：向接電話的人詢問他的身份</p>
                <input type="text" id="stage2Input" placeholder="輸入密碼...">
                <button id="stage2Btn">發送</button>
                <p class="error-message" id="stage2Error"></p>
                <button class="challenge-btn" id="challenge2Btn" style="display: none;">進入挑戰：字母拼字挑戰</button>
            </div>
            <div class="key-effect" style="display: none;">
                <svg width="50" height="50" viewBox="0 0 50 50">
                    <path d="M10 10 L20 20 M20 10 L10 20" stroke="#fbdc05" stroke-width="2"/>
                </svg>
            </div>
            <div class="hint-card" id="hint2">
                <p>你獲得【電話號碼】功能，並請前往下一個目的地：紅菱道休憩處!!</p>
            </div>
            <button class="hint-btn" id="showHint2">下一站地點</button>
        </div>

        <!-- 第三關：紅菱道 -->
        <div class="stage" id="stage3">
            <h2 class="stage-title">第三關：休養生息 (心連心傳密碼)</h2>
            <div class="story-section">
                <p>＊故事劇情＊</p>
                <p>通過與電話中人的交流，你被引導到紅菱道，這裡有許多活動和休憩空間。</p>
                <p>「哪裡有休憩處，市民都會平時去的地方，唔通果度有咩特別?」你思考著。</p>
            </div>
            <div class="dialogue-container show" id="stage3-dialogue">
                <p class="dialogue-text"><span class="dialogue-name">突破方法:</span>參考關卡遊戲卡片</p>
            </div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">📍</span>當前位置</h3>
                <div class="location-path">
                    <div class="location-step">善匯</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">熟悉的巴士線</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">餐廳</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step active">休憩處</div>
                </div>
                <p class="location-clue">密碼需要透過完成任務後獲得。</p>
            </div>
            <div class="story-section objective">
                <p><strong>目標：</strong>傳出正確的密碼</p>
            </div>
            <div class="community-map" id="communityMap">
                <svg width="100%" height="100%" viewBox="0 0 500 250">
                    <rect x="0" y="0" width="500" height="250" fill="#1a1a2e"/>
                    <path d="M50,125 L450,125 M250,50 L250,200" stroke="#303050" stroke-width="15" stroke-dasharray="10 5"/>
                    <g class="community-building" id="activityRoom">
                        <rect x="80" y="30" width="80" height="60" fill="none" stroke="#505080" stroke-width="2" stroke-dasharray="5 3"/>
                        <text class="community-label" x="120" y="65">寵物公園</text>
                    </g>
                    <g class="community-building" id="infoCenter">
                        <rect x="210" y="100" width="80" height="60" fill="none" stroke="#505080" stroke-width="2" stroke-dasharray="5 3"/>
                        <text class="community-label" x="250" y="135">有蓋</text>
                    </g>
                    <g class="community-building pulse" id="restArea">
                        <rect x="340" y="170" width="80" height="60" fill="none" stroke="#9050a0" stroke-width="2"/>
                        <text class="community-label" x="380" y="205">休憩處</text>
                    </g>
                </svg>
            </div>
            <div class="input-section">
                <p class="hint">提示：尋找紅菱道裡頂天立地的區域</p>
                <input type="text" id="stage3Input" placeholder="輸入密碼...">
                <button id="stage3Btn">確認</button>
                <p class="error-message" id="stage3Error"></p>
                <button class="challenge-btn" id="challenge3Btn" style="display: none;">進入挑戰：心連心傳密碼</button>
            </div>
            <div class="key-effect" style="display: none;">
                <svg width="50" height="50" viewBox="0 0 50 50">
                    <path d="M10 10 L20 20 M20 10 L10 20" stroke="#fbdc05" stroke-width="2"/>
                </svg>
            </div>
            <div class="hint-card" id="hint3">
                <p>你獲得【社區探索】功能，並請前往下一個目的地：小食店!!</p>
            </div>
            <button class="hint-btn" id="showHint3">下一站地點</button>
        </div>

        <!-- 第四關：小食店 -->
        <div class="stage" id="stage4">
            <h2 class="stage-title">第四關：解饞 (默契大考驗動作篇)</h2>
            <div class="story-section">
                <p>＊故事劇情＊</p>
                <p>每個人內心都有不同聲音，如何找到共識。</p>
                <p>「建立共同的回憶」</p>
            </div>
            <div class="dialogue-container show" id="stage4-dialogue">
                <p class="dialogue-text"><span class="dialogue-name">突破方法:</span>參考關卡遊戲卡片</p>
            </div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">📍</span>當前位置</h3>
                <div class="location-path">
                    <div class="location-step">善匯</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">熟悉的巴士線</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">餐廳</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">紅菱道休憩地</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step active">小食店</div>
                </div>
                <p class="location-clue">密碼需要透過完成任務後獲得。</p>
            </div>
            <div class="story-section objective">
                <p><strong>目標：</strong>珍惜所擁有的一分鐘，思考如何做出相同的動作</p>
            </div>
            <div class="treasure-box" id="treasureBox"></div>
            <div class="money-collection">
                <div class="money-item">
                    <span class="money-value">家</span>
                </div>
                <div class="money-item">
                    <span class="money-value">和</span>
                </div>
                <div class="money-item">
                    <span class="money-value">萬事</span>
                </div>
                <div class="money-item">
                    <span class="money-value">興</span>
                </div>
            </div>
            <div class="story-section note">
                <p>囚禁內心的寶箱在告訴你，時間無多，儀式一旦完成，孤獨從此降臨到每個人身上...</p>
            </div>
            <div class="input-section">
                <p class="hint">/</p>
                <input type="password" id="stage4Input" placeholder="輸入密碼...">
                <button id="stage4Btn">開啟</button>
                <p class="error-message" id="stage4Error"></p>
                <button class="challenge-btn" id="challenge4Btn" style="display: none;">進入挑戰：默契大考驗動作篇</button>
            </div>
            <div class="key-effect" style="display: none;">
                <svg width="50" height="50" viewBox="0 0 50 50">
                    <path d="M10 10 L20 20 M20 10 L10 20" stroke="#fbdc05" stroke-width="2"/>
                </svg>
            </div>
            <div class="hint-card" id="hint4">
                <p>你獲得【金錢】功能，並請前往下一個目的地：家興!!</p>
            </div>
            <button class="hint-btn" id="showHint4">下一站地點</button>
        </div>

        <!-- 第五關：家興 -->
        <div class="stage" id="stage5">
            <h2 class="stage-title">第五關：家和萬事興 (開口中)</h2>
            <div class="story-section">
                <p>＊故事劇情＊</p>
                <p>這裡有各種食物的圖像和記憶。你需要找出這些食物代表的共同場所。</p>
                <p>「這裡有些密碼...需要買到相關的藥水」</p>
                <p>你開始理解一個人是無法到達這裡。</p>
            </div>
            <div class="dialogue-container show" id="stage5-dialogue">
                <p class="dialogue-text"><span class="dialogue-name">突破方法:</span>參考關卡遊戲卡片</p>
            </div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">📍</span>當前位置</h3>
                <div class="location-path">
                    <div class="location-step">善匯</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">熟悉的巴士線</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">餐廳</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">紅菱道休憩地</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">小食店</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step active">家興</div>
                </div>
                <p class="location-clue">密碼需要透過完成任務後獲得。</p>
            </div>
            <div class="story-section objective">
                <p><strong>目標：</strong>一方面要猜中，另一方面要記著提示</p>
            </div>
            <div class="inventory" id="foodInventory">
                <div class="food-item">
                    <div class="food-img">🍗</div>
                    <p>雞翼</p>
                </div>
                <div class="food-item">
                    <div class="food-img">🍚</div>
                    <p>米飯</p>
                </div>
                <div class="food-item">
                    <div class="food-img">🥚</div>
                    <p>蒸水蛋</p>
                </div>
                <div class="food-item">
                    <div class="food-img">🦐</div>
                    <p>越南蝦</p>
                </div>
                <div class="food-item">
                    <div class="food-img">🍷</div>
                    <p>花雕酒</p>
                </div>
                <div class="food-item">
                    <div class="food-img">🧁</div>
                    <p>蛋糕</p>
                </div>
            </div>
            <div class="story-section note">
                <p>當你觸碰這些食物圖像時，閃過一些模糊的記憶片段：人們買賣、交談、討價還價的場景，這些都發生在一個熱鬧的地方...</p>
            </div>
            <div class="input-section">
                <p class="hint">提示：這些食物共同代表著社區中的哪個地方？</p>
                <input type="text" id="stage5Input" placeholder="輸入密碼...">
                <button id="stage5Btn">確認</button>
                <p class="error-message" id="stage5Error"></p>
                <button class="challenge-btn" id="challenge5Btn" style="display: none;">進入挑戰：開口中</button>
            </div>
            <div class="key-effect" style="display: none;">
                <svg width="50" height="50" viewBox="0 0 50 50">
                    <path d="M10 10 L20 20 M20 10 L10 20" stroke="#fbdc05" stroke-width="2"/>
                </svg>
            </div>
            <div class="hint-card" id="hint5">
                <p>你獲得【心靈相通】功能，並請前往下一個目的地：街市!!</p>
            </div>
            <button class="hint-btn" id="showHint5">下一站地點</button>
        </div>

        <!-- 第六關：街市 -->
        <div class="stage" id="stage6">
            <h2 class="stage-title">第六關：在彼此生命相遇 (大電視解謎)</h2>
            <div class="story-section">
                <p>＊故事劇情＊</p>
                <p>你來到街市，這裡熱鬧非凡，充滿了食物和人情味。在這裡，所有的線索和記憶都交匯在一起，指向最終的目的地。</p>
                <p>「家與回憶，邊個地有似家的感覺，又有呢D食物回憶，就係善匯，然後回善匯」</p>
                <p>在街市中漫步，你感受到這裡與所有地方的連結，但同時也明白這只是旅程的一部分，真正的「家」還在別處。</p>
            </div>
            <div class="dialogue-container show" id="stage6-dialogue">
                <p class="dialogue-text"><span class="dialogue-name">突破方法:</span>參考關卡遊戲卡片</p>
            </div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">📍</span>當前位置</h3>
                <div class="location-path">
                    <div class="location-step">善匯</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">熟悉的巴士線</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">餐廳</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">紅菱道休憩地</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">小食店</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">家興</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step active">街市</div>
                </div>
                <p class="location-clue">密碼需要透過完成任務後獲得。</p>
            </div>
            <div class="story-section objective">
                <p><strong>目標：</strong>思考如何表達，哪些人估，哪些人容易表達</p>
            </div>
            <div class="map-container" id="finalMap">
                <div class="location" style="top: 20%; left: 20%">
                    <span class="location-label">家興</span>
                </div>
                <div class="location" style="top: 40%; left: 50%">
                    <span class="location-label">街市、家興</span>
                </div>
                <div class="location" style="top: 60%; left: 70%">
                    <span class="location-label">紅菱道休憩處</span>
                </div>
                <div class="location" style="top: 70%; left: 30%">
                    <span class="location-label">餐廳、小食店</span>
                </div>
                <div class="location" style="top: 40%; left: 80%">
                    <span class="location-label">熟悉的巴士線</span>
                </div>
                <div class="location pulse" style="top: 70%; left: 50%">
                    <span class="location-label">you</span>
                </div>
            </div>
            <div class="story-section note">
                <p>當你在街市中流連，發現所有的商販、顧客都在談論著同一個地方，那是社區的心臟，所有人情味和連結的源頭，它的名字是...</p>
            </div>
            <div class="input-section">
                <p class="hint">輸入最後密碼，並前往終點完成遊戲</p>
                <input type="text" id="stage6Input" placeholder="輸入密碼...">
                <button id="stage6Btn">確認</button>
                <p class="error-message" id="stage6Error"></p>
                <button class="challenge-btn" id="challenge6Btn" style="display: none;">進入挑戰：大電視解謎</button>
            </div>
            <div class="key-effect" style="display: none;">
                <svg width="50" height="50" viewBox="0 0 50 50">
                    <path d="M10 10 L20 20 M20 10 L10 20" stroke="#fbdc05" stroke-width="2"/>
                </svg>
            </div>
            <div class="hint-card" id="hint6">
                <p>你獲得【回復記憶】功能，並請前終極目的地!!</p>
            </div>
            <button class="hint-btn" id="showHint6">下一站地點</button>
        </div>

        <!-- 結局 -->
        <div class="stage" id="ending">
            <h2 class="stage-title">心之回歸：尋回「家」的感覺</h2>
            <div class="story-section">
                <p>當你說出「善匯」的名字，所有記憶瞬間融合，強烈的光芒閃耀。你終於找到了心之鎖匙，也找到了真正的「家」。</p>
                <p>「恭喜你找到了心之鎖匙。現在你明白了，善匯不僅是一個地方，更是一種連結、一種情感、一種歸屬感。」</p>
                <p>「你不是孤單的旅行者，實際上，你一直都是善匯的一部分，而善匯的記憶也是你的一部分。」</p>
            </div>
            <div class="dialogue-container show" id="ending-dialogue">
                <p class="dialogue-text"><span class="dialogue-name">我們:</span>匯不只是一個地方，而是我們共同創造的心靈家園。</p>
            </div>
            <div class="void-heart filling" id="endingHeart"></div>
            <div class="location-guide">
                <h3 class="location-title"><span class="location-icon">🏠</span>回到起點</h3>
                <div class="location-path">
                    <div class="location-step">善匯</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">熟悉的巴士線</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">餐廳</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">紅菱道休憩地</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">小食店</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">家興</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step">街市</div>
                    <span class="location-arrow">→</span>
                    <div class="location-step active">善匯(終點)</div>
                </div>
                <p class="location-clue">旅程結束了，但「家」的故事才剛剛開始。</p>
            </div>
            <div class="story-section">
                <p>光芒漸漸消散，迷霧散去。你發現自己站在熟悉的善匯，周圍是熟悉的面孔，但這次，每個人的眼中都充滿了生命力和情感。</p>
                <p>你環顧四周，理解了一切。這不是一個迷途的異空間，而是你們共同創造的家園。而「心之鎖匙」，正是彼此間的連結和關懷。</p>
            </div>
            <div class="achievements">
                <div class="achievement unlocked" id="achievement1End">
                    🔍
                    <span class="achievement-label">迷境探索者</span>
                </div>
                <div class="achievement unlocked" id="achievement2End">
                    💬
                    <span class="achievement-label">虛實連結者</span>
                </div>
                <div class="achievement unlocked" id="achievement3End">
                    🧩
                    <span class="achievement-label">謎題解鎖者</span>
                </div>
                <div class="achievement unlocked" id="achievement4End">
                    🤝
                    <span class="achievement-label">心靈修復師</span>
                </div>
                <div class="achievement unlocked" id="achievement5End">
                    🏆
                    <span class="achievement-label">善匯守護者</span>
                </div>
            </div>
            <div class="effect-container" id="endingEffect"></div>
            <div class="notebook" id="notebook-ending">
                <div class="notebook-inner">
                    <div class="notebook-front">
                        <div class="envelope-icon">✉️</div>
                    </div>
                    <div class="notebook-back">
                        <h3 class="notebook-title">迷途筆記 - 終章</h3>
                        <p class="notebook-entry">旅程結束了，找回心之鎖匙並不是找到某個物品，而是重新連接與社區、與他人的情感紐帶。</p>
                        <p class="notebook-entry"><span class="notebook-highlight">善匯</span>不只是一個地方，而是所有人共同創造的<span class="notebook-highlight">心靈家園</span>。正如它的名字所暗示：善良匯聚之處，就是我真正的家。</p>
                    </div>
                </div>
            </div>
            <div class="input-section">
                <button id="restartBtn">重新開始旅程</button>
            </div>
        </div>

        <!-- Code2 關卡 -->
        <!-- 紅菱道 - 心連心傳密碼 -->
        <div class="game-section" id="community-center">
            <div class="game-title">
                <span class="location-tag">紅菱道</span>
                <h3>心連心傳密碼</h3>
            </div>
            <div class="game-description">
                <p>在這個挑戰中，你們需要圍成一圈，閉上眼睛，手拉手傳遞密碼（通過握手和拍子方式）。</p>
                <p>工作員會隨機打出一段密碼，你們需要準確地傳遞這個密碼。隨著嘗試次數的減少，難度會逐漸增加。</p>
                <p>只有當密碼完整傳遞一圈，才能算作成功！</p>
            </div>
            <div class="game-content circle-game">
                <div class="circle-animation" id="circle-container">
                    <!-- 玩家圖示將通過JS動態生成 -->
                </div>
                <div class="password-display" id="password-display">- - - -</div>
                <div class="attempts-counter">剩餘嘗試次數: <span id="attempts">3</span></div>
            </div>
            <div class="control-panel">
                <button class="control-button" id="generate-password">生成密碼</button>
                <button class="control-button" id="simulate-game">模擬遊戲</button>
                <button class="control-button" id="reset-circle-game">重置</button>
                <button class="control-button" id="return-stage3">完成挑戰，返回輸入密碼</button>
            </div>
            <div class="success-message" id="circle-success">
                恭喜！密碼成功傳遞完成。請點擊「完成挑戰」返回輸入密碼。
            </div>
        </div>

        <!-- 交通 - 巴士線配對 -->
        <div class="game-section" id="bus-route">
            <div class="game-title">
                <span class="location-tag">交通</span>
                <h3>巴士線配對</h3>
            </div>
            <div class="game-description">
                <p>在紅磡港鐵站對出巴士總站，完成以下巴士線路配對任務。</p>
                <p>填寫正確的巴士線，配對合適的目的地。填寫完成後，在上車位置拍照留念。</p>
                <p>總共有5道題目，全部答對才能獲得下一個地點的提示。</p>
            </div>
            <div class="game-content bus-matching">
                <div class="bus-question">
                    <span>1. 紅磡 - (</span>
                    <input type="text" class="bus-answer" data-answer="15X" placeholder="巴士線">
                    <span>) 藍田</span>
                    <div class="check-result">
                        <span class="check-icon">✓</span>
                    </div>
                </div>
                <div class="bus-question">
                    <span>2. 紅磡 - (</span>
                    <input type="text" class="bus-answer" data-answer="11K" placeholder="巴士線">
                    <span>) 竹園</span>
                    <div class="check-result">
                        <span class="check-icon">✓</span>
                    </div>
                </div>
                <div class="bus-question">
                    <span>3. 紅磡 - (</span>
                    <input type="text" class="bus-answer" data-answer="87D" placeholder="巴士線">
                    <span>) 馬鞍山運動場</span>
                    <div class="check-result">
                        <span class="check-icon">✓</span>
                    </div>
                </div>
                <div class="bus-question">
                    <span>4. 紅磡 - (</span>
                    <input type="text" class="bus-answer" data-answer="A20/A21" placeholder="巴士線">
                    <span>) 機場</span>
                    <div class="check-result">
                        <span class="check-icon">✓</span>
                    </div>
                </div>
                <div class="bus-question">
                    <span>5. 通宵時間紅磡 - (</span>
                    <input type="text" class="bus-answer" data-answer="N271" placeholder="巴士線">
                    <span>) 大埔</span>
                    <div class="check-result">
                        <span class="check-icon">✓</span>
                    </div>
                </div>
            </div>
            <div class="control-panel">
                <button class="control-button" id="check-bus-answers">檢查答案</button>
                <button class="control-button" id="reset-bus-game">重置</button>
                <button class="control-button" id="return-stage1">完成挑戰，返回輸入密碼</button>
            </div>
            <div class="success-message" id="bus-success">
                恭喜！全部答對。請點擊「完成挑戰」返回輸入密碼。
            </div>
        </div>

        <!-- 休憩處 - 默契大考驗動作篇 -->
        <div class="game-section" id="rest-area">
            <div class="game-title">
                <span class="location-tag">休憩處</span>
                <h3>默契大考驗動作篇</h3>
            </div>
            <div class="game-description">
                <p>在紅菱道休憩處，進行默契大考驗。</p>
                <p>工作員會出一條題目，數1、2、3後，所有組員要做出相同的動作。</p>
                <p>成功完成3題或以上，小組可獲得$100現金獎勵！</p>
            </div>
            <div class="game-content action-challenge">
                <div class="action-display" id="action-display">點擊下方按鈕開始</div>
                <div class="countdown" id="countdown"></div>
                <div class="success-counter">成功次數: <span id="action-success-count">0</span>/10</div>
            </div>
            <div class="control-panel">
                <button class="control-button" id="next-action">下一個動作</button>
                <button class="control-button" id="start-countdown">開始倒數</button>
                <button class="control-button" id="mark-success">標記成功</button>
                <button class="control-button" id="return-stage4">完成挑戰，返回輸入密碼</button>
            </div>
            <div class="success-message" id="action-success">
                恭喜！已成功達到目標。請點擊「完成挑戰」返回輸入密碼。
            </div>
        </div>

        <!-- 家興 - 開口中 -->
        <div class="game-section" id="ka-hing">
            <div class="game-title">
                <span class="location-tag">家興</span>
                <h3>開口中</h3>
            </div>
            <div class="game-description">
                <p>在家興超市，進行開口中遊戲。</p>
                <p>工作員會設定一個1到100的數字，每個組員輪流猜數字，逐漸縮小範圍，直到有人猜中正確數字。</p>
                <p>總共3回合，每猜中一次會獲得一個提示。集齊三個提示後，需要在超市購買指定物品才算完成任務。</p>
            </div>
            <div class="game-content number-guessing">
                <h4>第 <span id="round-count">1</span> 回合</h4>
                <div class="number-range">範圍: <span id="min-range">1</span> - <span id="max-range">100</span></div>
                <div class="guess-input">
                    <input type="number" id="guess-number" min="1" max="100" placeholder="輸入數字">
                    <button class="guess-button" id="submit-guess">猜！</button>
                </div>
                <div class="clues-container">
                    <div class="clue" id="clue-1" data-target="27">
                        <h4>提示 1:</h4>
                        <p>???</p>
                    </div>
                    <div class="clue" id="clue-2" data-target="78">
                        <h4>提示 2:</h4>
                        <p>???</p>
                    </div>
                    <div class="clue" id="clue-3" data-target="34">
                        <h4>提示 3:</h4>
                        <p>???</p>
                    </div>
                </div>
            </div>
            <div class="control-panel">
                <button class="control-button" id="reset-guess-game">重置</button>
                <button class="control-button" id="reveal-answer">揭曉答案</button>
                <button class="control-button" id="return-stage5">完成挑戰，返回輸入密碼</button>
            </div>
            <div class="success-message" id="guess-success">
                恭喜！獲得全部提示：罐裝飲品、有汽的、紅色。需要購買可樂才能完成任務！請點擊「完成挑戰」返回輸入密碼。
            </div>
        </div>

        <!-- 餐廳/小食店 - 字母拼字挑戰 -->
        <div class="game-section" id="restaurant">
            <div class="game-title">
                <span class="location-tag">餐廳/小食店</span>
                <h3>字母拼字挑戰</h3>
            </div>
            <div class="game-description">
                <p>在餐廳/小食店前，進行字母拼字挑戰。</p>
                <p>組員需用身體姿勢組成字母，拼出指定單字，並拍照留念。</p>
                <p>根據參與人數，挑戰的單詞會有所不同。</p>
            </div>
            <div class="game-content letter-challenge">
                <div class="people-counter">
                    <button class="counter-button" id="decrease-people">-</button>
                    <div class="people-count" id="people-count">4</div>
                    <button class="counter-button" id="increase-people">+</button>
                </div>
                <h4>你們需要拼出的單詞是：</h4>
                <div class="word-display" id="word-display">LIKE</div>
            </div>
            <div class="control-panel">
                <button class="control-button" id="confirm-word">確認完成</button>
                <button class="control-button" id="return-stage2">完成挑戰，返回輸入密碼</button>
            </div>
            <div class="success-message" id="word-success">
                恭喜！成功完成拼字挑戰。請點擊「完成挑戰」返回輸入密碼。
            </div>
        </div>

        <!-- 街市 - 大電視解謎 -->
        <div class="game-section" id="market">
            <div class="game-title">
                <span class="location-tag">街市</span>
                <h3>大電視解謎</h3>
            </div>
            <div class="game-description">
                <p>在街市，進行大電視解謎遊戲。</p>
                <p>一位組員需要用肢體語言或描述方式表達題目，但不能說出題目中的關鍵詞，其他組員需要猜出正確答案。</p>
                <p>總共15題，目標是至少完成8題才能成功！</p>
            </div>
            <div class="game-content tv-game">
                <div class="tv-screen" id="tv-screen">
                    點擊「下一題」開始
                </div>
                <div class="tv-controls">
                    <button class="control-button" id="next-tv-word">下一題</button>
                    <button class="control-button" id="mark-tv-correct">答對</button>
                </div>
                <div class="progress-display">
                    進度: <span id="tv-progress">0</span>/15 (目標: 8題)
                </div>
            </div>
            <div class="control-panel">
                <button class="control-button" id="reset-tv-game">重置</button>
                <button class="control-button" id="return-stage6">完成挑戰，返回輸入密碼</button>
            </div>
            <div class="success-message" id="tv-success">
                恭喜！成功完成大電視解謎。請點擊「完成挑戰」返回輸入密碼。
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentStage = 0;
            const totalStages = 6;
            const stages = ['intro', 'stage1', 'stage2', 'stage3', 'stage4', 'stage5', 'stage6', 'ending'];
            const challenges = ['bus-route', 'restaurant', 'community-center', 'rest-area', 'ka-hing', 'market'];

            const answers = {
                stage1: 'sidebyside',
                stage2: 'socialworker',
                stage3: 'always',
                stage4: 'be',
                stage5: 'with',
                stage6: 'you'
            };

            const alternativeAnswers = {
                stage2: ['KYLE', 'kyle'],
                stage3: ['KYLE', 'kyle'],
                stage4: ['KYLE', 'kyle'],
                stage5: ['KYLE', 'kyle'],
                stage6: ['KYLE', 'kyle']
            };

        const cutscenes = {
            intro: { title: "起點 (善匯)", text: "「陌生還是熟悉的社區?」" },
            stage1: { title: "第一關：出行易", text: "「有人知道我在哪裡嗎?」" },
            stage2: { title: "第二關：熟悉的人 (餐廳)", text: "你獲得【手機通訊—可致電】功能" },
            stage3: { title: "第三關：休養生息 (紅菱道休憩處)", text: "你獲得【討論共識—1分鐘討論】功能" },
            stage4: { title: "第四關：解饞 (小食店)", text: "你獲得【討論共識—1分鐘討論】功能" },
            stage5: { title: "第五關：家和萬事興 (家興)", text: "你獲得【心靈相通機會3次】功能" },
            stage6: { title: "第六關：在彼此生命相遇 (街市)", text: "你獲得【跳題3次】功能" },
            ending: { title: "回家 (善匯)", text: "當你說出「善匯」的名字，所有記憶瞬間融合，強烈的光芒閃耀。你終於找到了心之鎖匙，也找到了真正的「家」。" }
        };

                const envelopeContent = {
            intro: { title: "起點 (善匯)", content: "Start" },
            stage1: { title: "第一關：出行易", content: "Remember" },
            stage2: { title: "第二關：熟悉的人 (餐廳)", content: "Remember: SideBySide" },
            stage3: { title: "第三關：休養生息 (紅菱道休憩處)", content: "Remember: SideBySide Social worker" },
            stage4: { title: "第四關：解饞 (小食店)", content: "Remember: SideBySide Social worker always" },
            stage5: { title: "第五關：家和萬事興 (家興)", content: "Remember: SideBySide Social worker always be" },
            stage6: { title: "第六關：在彼此生命相遇 (街市)", content: "Remember: SideBySide Social worker always be with" },
            ending: { title: "回家 (善匯)", content: "Remember: SideBySide Social worker always be with you<3" }
        };
        
            const notebooks = document.querySelectorAll('.notebook');
            notebooks.forEach(notebook => {
                notebook.addEventListener('click', function() {
                    this.classList.toggle('flipped');
                });
            });

            function updateProgress() {
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = (currentStage / totalStages) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                for (let i = 0; i <= totalStages; i++) {
                    const node = document.getElementById(`node${i}`);
                    if (node) {
                        if (i < currentStage) {
                            node.classList.remove('current', 'locked');
                            node.classList.add('completed');
                        } else if (i === currentStage) {
                            node.classList.remove('completed', 'locked');
                            node.classList.add('current');
                        } else {
                            node.classList.remove('completed', 'current');
                            node.classList.add('locked');
                        }
                    }
                }
            }

            function showEnvelope(stage) {
                const envelope = document.getElementById('envelope-container');
                const letterTitle = document.getElementById('letter-title');
                const letterContent = document.getElementById('letter-content');
                letterTitle.textContent = envelopeContent[stages[stage]].title;
                letterContent.textContent = envelopeContent[stages[stage]].content;
                envelope.classList.add('active');
                setTimeout(() => {
                    envelope.classList.add('opening');
                    setTimeout(() => {
                        envelope.classList.remove('opening');
                        setTimeout(() => {
                            envelope.classList.remove('active');
                            setTimeout(() => {
                                showCutscene(stage);
                            }, 500);
                        }, 2000);
                    }, 5000);
                }, 1000);
                envelope.addEventListener('click', function closeHandler() {
                    envelope.classList.remove('opening');
                    setTimeout(() => {
                        envelope.classList.remove('active');
                    }, 500);
                    envelope.removeEventListener('click', closeHandler);
                    setTimeout(() => {
                        showCutscene(stage);
                    }, 500);
                });
            }

            function showCutscene(stage) {
                const cutscene = document.getElementById('cutscene');
                const cutsceneTitle = document.getElementById('cutscene-title');
                const cutsceneText = document.getElementById('cutscene-text');
                cutsceneTitle.textContent = cutscenes[stages[stage]].title;
                cutsceneText.textContent = cutscenes[stages[stage]].text;
                cutscene.classList.add('active');
                cutscene.addEventListener('click', function closeHandler() {
                    cutscene.classList.remove('active');
                    cutscene.removeEventListener('click', closeHandler);
                });
                setTimeout(() => {
                    cutscene.classList.remove('active');
                }, 6000);
            }

            function switchStage(fromStage, toStage) {
                document.getElementById(stages[fromStage]).classList.remove('active');
                document.getElementById(stages[toStage]).classList.add('active');
                challenges.forEach(challenge => {
                    document.getElementById(challenge).classList.remove('active');
                });
                currentStage = toStage;
                updateProgress();
                notebooks.forEach(notebook => {
                    notebook.classList.remove('flipped');
                });
                document.getElementById(stages[toStage]).style.animation = 'none';
                setTimeout(() => {
                    document.getElementById(stages[toStage]).style.animation = 'fadeIn 1s ease';
                }, 10);
                showEnvelope(toStage);
                if (toStage === 2) initPhoneChat();
                else if (toStage === 4) initTreasureBox();
                else if (toStage === 7) createEndingEffect();
                createSceneTransitionEffect();
            }

            function showChallenge(challengeIndex) {
                document.getElementById(stages[currentStage]).classList.remove('active');
                challenges.forEach(challenge => {
                    document.getElementById(challenge).classList.remove('active');
                });
                document.getElementById(challenges[challengeIndex]).classList.add('active');
                createSceneTransitionEffect();
                if (challengeIndex === 0) resetBusGame();
                else if (challengeIndex === 2) resetCircleGame();
                else if (challengeIndex === 3) resetActionGame();
                else if (challengeIndex === 4) resetGuessGame();
                else if (challengeIndex === 5) resetTvGame();
            }

            function returnToStage(stageIndex) {
                document.getElementById(challenges[stageIndex - 1]).classList.remove('active');
                document.getElementById(stages[stageIndex]).classList.add('active');
                createSceneTransitionEffect();
            }

            function createSceneTransitionEffect() {
                const gameContainer = document.querySelector('.game-container');
                const effectContainer = document.createElement('div');
                effectContainer.className = 'effect-container';
                gameContainer.appendChild(effectContainer);
                for (let i = 0; i < 30; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = `${Math.random() * 100}%`;
                    sparkle.style.top = `${Math.random() * 100}%`;
                    sparkle.style.opacity = '0';
                    effectContainer.appendChild(sparkle);
                    setTimeout(() => {
                        sparkle.style.transition = 'all 0.8s ease';
                        sparkle.style.opacity = '1';
                        setTimeout(() => {
                            sparkle.style.opacity = '0';
                        }, 600);
                    }, Math.random() * 300);
                }
                setTimeout(() => {
                    effectContainer.remove();
                }, 1500);
            }
        
        function createEffect(element, type) {
            const effectContainer = document.createElement('div');
            effectContainer.className = 'effect-container';
            element.appendChild(effectContainer);
            if (type === 'confetti') {
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.top = `${Math.random() * 100}%`;
                    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    confetti.style.width = `${5 + Math.random() * 10}px`;
                    confetti.style.height = `${5 + Math.random() * 10}px`;
                    confetti.style.opacity = '1';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    effectContainer.appendChild(confetti);
                    setTimeout(() => {
                        confetti.style.transition = 'all 2s ease';
                        confetti.style.top = '100%';
                        confetti.style.opacity = '0';
                    }, Math.random() * 500);
                }
                setTimeout(() => {
                    effectContainer.remove();
                }, 3000);
            } else if (type === 'sparkle') {
                for (let i = 0; i < 30; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = `${Math.random() * 100}%`;
                    sparkle.style.top = `${Math.random() * 100}%`;
                    sparkle.style.opacity = '1';
                    effectContainer.appendChild(sparkle);
                    setTimeout(() => {
                        sparkle.style.transition = 'all 1s ease';
                        sparkle.style.transform = `translate(${(Math.random() - 0.5) * 100}px, ${(Math.random() - 0.5) * 100}px)`;
                        sparkle.style.opacity = '0';
                    }, Math.random() * 300);
                }
                setTimeout(() => {
                    effectContainer.remove();
                }, 2000);
            }
        }
        
        function initPhoneChat() {
            const phoneScreen = document.getElementById('phoneScreen');
            phoneScreen.innerHTML = '';
            const initialMessage = document.createElement('div');
            initialMessage.className = 'message incoming';
            initialMessage.textContent = '你好，...你需要什麼幫助嗎？';
            phoneScreen.appendChild(initialMessage);
        }
        
        function initTreasureBox() {
            const treasureBox = document.getElementById('treasureBox');
            treasureBox.classList.remove('open');
            treasureBox.addEventListener('click', function() {
                const input = document.getElementById('stage4Input').value;
                if (input === answers.stage4) {
                    treasureBox.classList.add('open');
                    createEffect(treasureBox, 'sparkle');
                    setTimeout(() => {
                        document.getElementById('stage4Btn').click();
                    }, 2000);
                } else {
                    treasureBox.classList.add('shake');
                    setTimeout(() => {
                        treasureBox.classList.remove('shake');
                    }, 500);
                    document.getElementById('stage4Error').textContent = '密碼錯誤，寶箱拒絕打開';
                }
            });
        }
        
        function createEndingEffect() {
            const endingEffect = document.getElementById('endingEffect');
            createEffect(endingEffect.parentElement, 'confetti');
            const title = document.querySelector('#ending .stage-title');
            title.classList.add('glow');
            setTimeout(() => {
                createEffect(endingEffect.parentElement, 'sparkle');
            }, 2000);
            setTimeout(() => {
                createEffect(endingEffect.parentElement, 'confetti');
            }, 4000);
        }
        
        function checkAnswer(stage, input) {
            input = input.trim().toLowerCase();
            if (input === answers[stage].toLowerCase()) return true;
            if (alternativeAnswers[stage]) {
                for (let i = 0; i < alternativeAnswers[stage].length; i++) {
                    if (input === alternativeAnswers[stage][i].toLowerCase() || 
                        input.includes(alternativeAnswers[stage][i].toLowerCase())) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        document.getElementById('showHint1').addEventListener('click', function() {
            document.getElementById('hint1').classList.toggle('show');
            this.textContent = document.getElementById('hint1').classList.contains('show') ? '隱藏' : '下一站地點';
        });
        document.getElementById('showHint2').addEventListener('click', function() {
            document.getElementById('hint2').classList.toggle('show');
            this.textContent = document.getElementById('hint2').classList.contains('show') ? '隱藏' : '下一站地點';
        });
        document.getElementById('showHint3').addEventListener('click', function() {
            document.getElementById('hint3').classList.toggle('show');
            this.textContent = document.getElementById('hint3').classList.contains('show') ? '隱藏' : '下一站地點';
        });
        document.getElementById('showHint4').addEventListener('click', function() {
            document.getElementById('hint4').classList.toggle('show');
            this.textContent = document.getElementById('hint4').classList.contains('show') ? '隱藏' : '下一站地點';
        });
        document.getElementById('showHint5').addEventListener('click', function() {
            document.getElementById('hint5').classList.toggle('show');
            this.textContent = document.getElementById('hint5').classList.contains('show') ? '隱藏' : '下一站地點';
        });
        document.getElementById('showHint6').addEventListener('click', function() {
            document.getElementById('hint6').classList.toggle('show');
            this.textContent = document.getElementById('hint6').classList.contains('show') ? '隱藏' : '下一站地點';
        });
        
        document.getElementById('gameStartBtn').addEventListener('click', function() {
            document.querySelector('.start-screen').style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
            updateProgress();
            setTimeout(() => {
                showEnvelope(0);
            }, 500);
        });
        
        document.getElementById('startBtn').addEventListener('click', function() {
            switchStage(0, 1);
        });
        
        document.getElementById('stage1Btn').addEventListener('click', function() {
            const input = document.getElementById('stage1Input').value.trim();
            const errorMsg = document.getElementById('stage1Error');
            const keyEffect = document.querySelector('#stage1 .key-effect');
            if (input === answers.stage1) {
                errorMsg.textContent = '';
                createEffect(this.parentElement, 'sparkle');
                keyEffect.style.display = 'block';
                setTimeout(() => {
                    keyEffect.classList.add('show');
                }, 10);
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 300);
                setTimeout(() => {
                    switchStage(1, 2);
                    keyEffect.classList.remove('show');
                    setTimeout(() => {
                        keyEffect.style.display = 'none';
                    }, 500);
                }, 2000);
            } else {
                errorMsg.textContent = '這不是正確的數字序列，繼續尋找熟悉的巴士線中的密碼';
                this.classList.add('shake');
                setTimeout(() => {
                    this.classList.remove('shake');
                }, 500);
            }
        });
        
        document.getElementById('stage2Btn').addEventListener('click', function() {
            const input = document.getElementById('stage2Input').value.trim().toLowerCase();
            const errorMsg = document.getElementById('stage2Error');
            const phoneScreen = document.getElementById('phoneScreen');
            const keyEffect = document.querySelector('#stage2 .key-effect');
            const userMessage = document.createElement('div');
            userMessage.className = 'message outgoing';
            userMessage.textContent = document.getElementById('stage2Input').value;
            phoneScreen.appendChild(userMessage);
            phoneScreen.scrollTop = phoneScreen.scrollHeight;
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message incoming';
            typingIndicator.innerHTML = '<span style="opacity: 0.7">...</span>';
            phoneScreen.appendChild(typingIndicator);
            setTimeout(() => {
                phoneScreen.removeChild(typingIndicator);
                if (checkAnswer('stage2', input)) {
                    errorMsg.textContent = '';
                    const replyMessage = document.createElement('div');
                    replyMessage.className = 'message incoming';
                    replyMessage.textContent = '我是善匯的社工。你現在應該前往紅菱道，可能會找到更多線索。';
                    phoneScreen.appendChild(replyMessage);
                    phoneScreen.scrollTop = phoneScreen.scrollHeight;
                    keyEffect.style.display = 'block';
                    setTimeout(() => {
                        keyEffect.classList.add('show');
                    }, 10);
                    this.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 300);
                    setTimeout(() => {
                        switchStage(2, 3);
                        keyEffect.classList.remove('show');
                        setTimeout(() => {
                            keyEffect.style.display = 'none';
                        }, 500);
                    }, 3000);
                } else {
                    const replyMessage = document.createElement('div');
                    replyMessage.className = 'message incoming';
                    replyMessage.textContent = '我不太明白你在說什麼...';
                    phoneScreen.appendChild(replyMessage);
                    phoneScreen.scrollTop = phoneScreen.scrollHeight;
                    errorMsg.textContent = '嘗試直接詢問對方的身份';
                }
            }, 1200);
            document.getElementById('stage2Input').value = '';
        });
        
        document.getElementById('stage3Btn').addEventListener('click', function() {
            const input = document.getElementById('stage3Input').value.trim().toLowerCase();
            const errorMsg = document.getElementById('stage3Error');
            const keyEffect = document.querySelector('#stage3 .key-effect');
            if (checkAnswer('stage3', input)) {
                errorMsg.textContent = '';
                createEffect(this.parentElement, 'sparkle');
                keyEffect.style.display = 'block';
                setTimeout(() => {
                    keyEffect.classList.add('show');
                }, 10);
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 300);
                setTimeout(() => {
                    switchStage(3, 4);
                    keyEffect.classList.remove('show');
                    setTimeout(() => {
                        keyEffect.style.display = 'none';
                    }, 500);
                }, 2000);
            } else {
                errorMsg.textContent = '這個地方似乎不是社區活動的主要場所，繼續尋找';
                this.classList.add('shake');
                setTimeout(() => {
                    this.classList.remove('shake');
                }, 500);
            }
        });
        
        document.getElementById('stage4Btn').addEventListener('click', function() {
            const input = document.getElementById('stage4Input').value;
            const errorMsg = document.getElementById('stage4Error');
            const treasureBox = document.getElementById('treasureBox');
            const keyEffect = document.querySelector('#stage4 .key-effect');
            if (input === answers.stage4) {
                errorMsg.textContent = '';
                if (!treasureBox.classList.contains('open')) {
                    treasureBox.classList.add('open');
                    createEffect(treasureBox, 'sparkle');
                }
                keyEffect.style.display = 'block';
                setTimeout(() => {
                    keyEffect.classList.add('show');
                }, 10);
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 300);
                setTimeout(() => {
                    switchStage(4, 5);
                    keyEffect.classList.remove('show');
                    setTimeout(() => {
                        keyEffect.style.display = 'none';
                    }, 500);
                }, 2000);
            } else {
                errorMsg.textContent = '密碼錯誤，寶箱拒絕打開';
                this.classList.add('shake');
                setTimeout(() => {
                    this.classList.remove('shake');
                }, 500);
            }
        });
        
        document.getElementById('stage5Btn').addEventListener('click', function() {
            const input = document.getElementById('stage5Input').value.trim().toLowerCase();
            const errorMsg = document.getElementById('stage5Error');
            const keyEffect = document.querySelector('#stage5 .key-effect');
            if (checkAnswer('stage5', input)) {
                errorMsg.textContent = '';
                createEffect(this.parentElement, 'sparkle');
                keyEffect.style.display = 'block';
                setTimeout(() => {
                    keyEffect.classList.add('show');
                }, 10);
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 300);
                setTimeout(() => {
                    switchStage(5, 6);
                    keyEffect.classList.remove('show');
                    setTimeout(() => {
                        keyEffect.style.display = 'none';
                    }, 500);
                }, 2000);
            } else {
                errorMsg.textContent = '這不是這些食物的共同來源，再思考購買新鮮食材的地方';
                this.classList.add('shake');
                setTimeout(() => {
                    this.classList.remove('shake');
                }, 500);
            }
        });
        
        document.getElementById('stage6Btn').addEventListener('click', function() {
            const input = document.getElementById('stage6Input').value.trim().toLowerCase();
            const errorMsg = document.getElementById('stage6Error');
            const keyEffect = document.querySelector('#stage6 .key-effect');
            if (checkAnswer('stage6', input)) {
                errorMsg.textContent = '';
                createEffect(this.parentElement, 'confetti');
                keyEffect.style.display = 'block';
                setTimeout(() => {
                    keyEffect.classList.add('show');
                }, 10);
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 300);
                setTimeout(() => {
                    switchStage(6, 7);
                    keyEffect.classList.remove('show');
                    setTimeout(() => {
                        keyEffect.style.display = 'none';
                    }, 500);
                }, 2000);
            } else {
                errorMsg.textContent = '當中只有一個答案是真的';
                this.classList.add('shake');
                setTimeout(() => {
                    this.classList.remove('shake');
                }, 500);
            }
        });
        
        document.getElementById('restartBtn').addEventListener('click', function() {
            location.reload();
        });
        
        document.querySelectorAll('.food-item').forEach(item => {
            item.addEventListener('click', function() {
                createEffect(this, 'sparkle');
                this.style.backgroundColor = 'rgba(74, 20, 140, 0.3)';
                setTimeout(() => {
                    const allSelected = Array.from(document.querySelectorAll('.food-item'))
                        .every(el => el.style.backgroundColor === 'rgba(74, 20, 140, 0.3)');
                    if (allSelected) {
                        document.getElementById('stage5Input').value = '街市';
                        document.getElementById('stage5Btn').click();
                    }
                }, 500);
            });
        });
        
        document.getElementById('activityRoom').addEventListener('click', function() {
            document.getElementById('stage3Input').value = '活動室';
            createEffect(this, 'sparkle');
        });
        document.getElementById('infoCenter').addEventListener('click', function() {
            document.getElementById('stage3Input').value = '資訊處';
            createEffect(this, 'sparkle');
        });
        document.getElementById('restArea').addEventListener('click', function() {
            document.getElementById('stage3Input').value = '休憩處';
            createEffect(this, 'sparkle');
            setTimeout(() => {
                document.getElementById('stage3Btn').click();
            }, 500);
        });
        
        document.querySelectorAll('#finalMap .location').forEach(location => {
            location.addEventListener('click', function() {
                const locationName = this.querySelector('.location-label').textContent;
                document.getElementById('stage6Input').value = locationName;
                createEffect(this, 'sparkle');
                if (locationName === '善匯') {
                    setTimeout(() => {
                        document.getElementById('stage6Btn').click();
                    }, 500);
                }
            });
        });
        
        document.getElementById('phoneButton').addEventListener('click', function() {
            this.style.backgroundColor = '#555';
            setTimeout(() => {
                this.style.backgroundColor = '#333';
            }, 200);
        });
    });
</script>

</body>
</html>

